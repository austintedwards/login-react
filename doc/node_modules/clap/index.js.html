<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/clap/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> MAX_LINE_WIDTH = process.stdout.columns || <span class="hljs-number">200</span>;
<span class="hljs-keyword">var</span> MIN_OFFSET = <span class="hljs-number">25</span>;

<span class="hljs-keyword">var</span> errorHandler;
<span class="hljs-keyword">var</span> commandsPath;

<span class="hljs-keyword">var</span> reAstral = <span class="hljs-regexp">/[\uD800-\uDBFF][\uDC00-\uDFFF]/g</span>;
<span class="hljs-keyword">var</span> ansiRegex = <span class="hljs-regexp">/\x1B\[([0-9]{1,3}(;[0-9]{1,3})*)?[m|K]/g</span>;
<span class="hljs-keyword">var</span> hasOwnProperty = <span class="hljs-built_in">Object</span>.prototype.hasOwnProperty;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stringLength</span>(<span class="hljs-params">str</span>)</span>{
  <span class="hljs-keyword">return</span> str
    .replace(ansiRegex, <span class="hljs-string">''</span>)
    .replace(reAstral, <span class="hljs-string">' '</span>)
    .length;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">camelize</span>(<span class="hljs-params">name</span>)</span>{
  <span class="hljs-keyword">return</span> name.replace(<span class="hljs-regexp">/-(.)/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m, ch</span>)</span>{
    <span class="hljs-keyword">return</span> ch.toUpperCase();
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assign</span>(<span class="hljs-params">dest, source</span>)</span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> source)
    <span class="hljs-keyword">if</span> (hasOwnProperty.call(source, key))
      dest[key] = source[key];

  <span class="hljs-keyword">return</span> dest;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">returnFirstArg</span>(<span class="hljs-params">value</span>)</span>{
  <span class="hljs-keyword">return</span> value;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pad</span>(<span class="hljs-params">width, str</span>)</span>{
  <span class="hljs-keyword">return</span> str + <span class="hljs-built_in">Array</span>(<span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, width - stringLength(str)) + <span class="hljs-number">1</span>).join(<span class="hljs-string">' '</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noop</span>(<span class="hljs-params"></span>)</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>nothing todo</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseParams</span>(<span class="hljs-params">str</span>)</span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>params [..<required>] [..[optional]]
<foo> - require
[foo] - optional</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> tmp;
  <span class="hljs-keyword">var</span> left = str.trim();
  <span class="hljs-keyword">var</span> result = {
    <span class="hljs-attr">minArgsCount</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">maxArgsCount</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">args</span>: []
  };

  <span class="hljs-keyword">do</span> {
    tmp = left;
    left = left.replace(<span class="hljs-regexp">/^&lt;([a-zA-Z][a-zA-Z0-9\-\_]*)&gt;\s*/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m, name</span>)</span>{
      result.args.push(<span class="hljs-keyword">new</span> Argument(name, <span class="hljs-literal">true</span>));
      result.minArgsCount++;
      result.maxArgsCount++;

      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    });
  }
  <span class="hljs-keyword">while</span> (tmp != left);

  <span class="hljs-keyword">do</span> {
    tmp = left;
    left = left.replace(<span class="hljs-regexp">/^\[([a-zA-Z][a-zA-Z0-9\-\_]*)\]\s*/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m, name</span>)</span>{
      result.args.push(<span class="hljs-keyword">new</span> Argument(name, <span class="hljs-literal">false</span>));
      result.maxArgsCount++;

      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    });
  }
  <span class="hljs-keyword">while</span> (tmp != left);

  <span class="hljs-keyword">if</span> (left)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Bad parameter description: '</span> + str);

  <span class="hljs-keyword">return</span> result.args.length ? result : <span class="hljs-literal">false</span>;
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> <span class="hljs-built_in">SyntaxError</span> = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>)</span>{
  <span class="hljs-keyword">this</span>.message = message;
};
<span class="hljs-built_in">SyntaxError</span>.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Error</span>.prototype);
<span class="hljs-built_in">SyntaxError</span>.prototype.name = <span class="hljs-string">'SyntaxError'</span>;
<span class="hljs-built_in">SyntaxError</span>.prototype.clap = <span class="hljs-literal">true</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> Argument = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, required</span>)</span>{
  <span class="hljs-keyword">this</span>.name = name;
  <span class="hljs-keyword">this</span>.required = required;
};
Argument.prototype = {
  <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">normalize</span>: returnFirstArg,
  <span class="hljs-attr">suggest</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> [];
  }
};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">usage</span>
<span class="dox_type">string</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">description</span>
<span class="dox_type">string</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> Option = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">usage, description</span>)</span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> params;
  <span class="hljs-keyword">var</span> left = usage.trim()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>short usage
-x</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    .replace(<span class="hljs-regexp">/^-([a-zA-Z])(?:\s*,\s*|\s+)/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m, name</span>)</span>{
      self.short = name;

      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    })
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>long usage
--flag
--no-flag - invert value if flag is boolean</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    .replace(<span class="hljs-regexp">/^--([a-zA-Z][a-zA-Z0-9\-\_]+)\s*/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m, name</span>)</span>{
      self.long = name;
      self.name = name.replace(<span class="hljs-regexp">/(^|-)no-/</span>, <span class="hljs-string">'$1'</span>);
      self.defValue = self.name != self.long;

      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    });

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.long)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Usage has no long name: '</span> + usage);

  <span class="hljs-keyword">try</span> {
    params = parseParams(left);
  } <span class="hljs-keyword">catch</span>(e) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Bad paramenter description in usage for option: '</span> + usage, e);
  }

  <span class="hljs-keyword">if</span> (params)
  {
    left = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.long;
    <span class="hljs-keyword">this</span>.defValue = <span class="hljs-literal">undefined</span>;

    assign(<span class="hljs-keyword">this</span>, params);
  }

  <span class="hljs-keyword">if</span> (left)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Bad usage description for option: '</span> + usage);

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.name)
    <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.long;

  <span class="hljs-keyword">this</span>.description = description || <span class="hljs-string">''</span>;
  <span class="hljs-keyword">this</span>.usage = usage.trim();
  <span class="hljs-keyword">this</span>.camelName = camelize(<span class="hljs-keyword">this</span>.name);
};

Option.prototype = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">short</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">long</span>: <span class="hljs-string">''</span>,

  <span class="hljs-attr">beforeInit</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">minArgsCount</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">maxArgsCount</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">args</span>: <span class="hljs-literal">null</span>,

  <span class="hljs-attr">defValue</span>: <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">normalize</span>: returnFirstArg
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Command</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createOption</span>(<span class="hljs-params">usage, description, opt_1, opt_2</span>)</span>{
  <span class="hljs-keyword">var</span> option = <span class="hljs-keyword">new</span> Option(usage, description);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>if (option.bool &amp;&amp; arguments.length &gt; 2)
throw new SyntaxError('bool flags can't has default value or validator');</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">3</span>)
  {
    <span class="hljs-keyword">if</span> (opt_1 &amp;&amp; opt_1.constructor === <span class="hljs-built_in">Object</span>)
    {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> opt_1)
        <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'normalize'</span> ||
            key == <span class="hljs-string">'defValue'</span> ||
            key == <span class="hljs-string">'beforeInit'</span>)
          option[key] = opt_1[key];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>old name for <code>beforeInit</code> setting is <code>hot</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (opt_1.hot)
        option.beforeInit = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">else</span>
    {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opt_1 == <span class="hljs-string">'function'</span>)
        option.normalize = opt_1;
      <span class="hljs-keyword">else</span>
        option.defValue = opt_1;
    }
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">4</span>)
  {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opt_1 == <span class="hljs-string">'function'</span>)
      option.normalize = opt_1;

    option.defValue = opt_2;
  }

  <span class="hljs-keyword">return</span> option;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addOptionToCommand</span>(<span class="hljs-params">command, option</span>)</span>{
  <span class="hljs-keyword">var</span> commandOption;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>short</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (option.short)
  {
    commandOption = command.short[option.short];

    <span class="hljs-keyword">if</span> (commandOption)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Short option name -'</span> + option.short + <span class="hljs-string">' already in use by '</span> + commandOption.usage + <span class="hljs-string">' '</span> + commandOption.description);

    command.short[option.short] = option;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>long</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  commandOption = command.long[option.long];

  <span class="hljs-keyword">if</span> (commandOption)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Long option --'</span> + option.long + <span class="hljs-string">' already in use by '</span> + commandOption.usage + <span class="hljs-string">' '</span> + commandOption.description);

  command.long[option.long] = option;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>camel</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  commandOption = command.options[option.camelName];

  <span class="hljs-keyword">if</span> (commandOption)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Name option '</span> + option.camelName + <span class="hljs-string">' already in use by '</span> + commandOption.usage + <span class="hljs-string">' '</span> + commandOption.description);

  command.options[option.camelName] = option;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>set default value</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> option.defValue != <span class="hljs-string">'undefined'</span>)
    command.setOption(option.camelName, option.defValue, <span class="hljs-literal">true</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>add to suggestions</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  command.suggestions.push(<span class="hljs-string">'--'</span> + option.long);

  <span class="hljs-keyword">return</span> option;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findVariants</span>(<span class="hljs-params">obj, entry</span>)</span>{
  <span class="hljs-keyword">return</span> obj.suggestions.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>)</span>{
    <span class="hljs-keyword">return</span> item.substr(<span class="hljs-number">0</span>, entry.length) == entry;
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processArgs</span>(<span class="hljs-params">command, args, suggest</span>)</span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processOption</span>(<span class="hljs-params">option, command</span>)</span>{
    <span class="hljs-keyword">var</span> params = [];

    <span class="hljs-keyword">if</span> (option.maxArgsCount)
    {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; option.maxArgsCount; j++)
      {
        <span class="hljs-keyword">var</span> suggestPoint = suggest &amp;&amp; i + <span class="hljs-number">1</span> + j &gt;= args.length - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">var</span> nextToken = args[i + <span class="hljs-number">1</span>];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>TODO: suggestions for options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (suggestPoint)
        {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>search for suggest</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          noSuggestions = <span class="hljs-literal">true</span>;
          i = args.length;
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (!nextToken || nextToken[<span class="hljs-number">0</span>] == <span class="hljs-string">'-'</span>)
          <span class="hljs-keyword">break</span>;

        params.push(args[++i]);
      }

      <span class="hljs-keyword">if</span> (params.length &lt; option.minArgsCount)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Option '</span> + token + <span class="hljs-string">' should be used with at least '</span> + option.minArgsCount + <span class="hljs-string">' argument(s)\nUsage: '</span> + option.usage);

      <span class="hljs-keyword">if</span> (option.maxArgsCount == <span class="hljs-number">1</span>)
        params = params[<span class="hljs-number">0</span>];
    }
    <span class="hljs-keyword">else</span>
    {
      params = !option.defValue;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>command.values[option.camelName] = newValue;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    resultToken.options.push({
      <span class="hljs-attr">option</span>: option,
      <span class="hljs-attr">value</span>: params
    });
  }

  <span class="hljs-keyword">var</span> resultToken = {
    <span class="hljs-attr">command</span>: command,
    <span class="hljs-attr">args</span>: [],
    <span class="hljs-attr">literalArgs</span>: [],
    <span class="hljs-attr">options</span>: []
  };
  <span class="hljs-keyword">var</span> result = [resultToken];

  <span class="hljs-keyword">var</span> suggestStartsWith = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> noSuggestions = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> collectArgs = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> commandArgs = [];
  <span class="hljs-keyword">var</span> noOptionsYet = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> option;

  commandsPath = [command.name];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++)
  {
    <span class="hljs-keyword">var</span> suggestPoint = suggest &amp;&amp; i == args.length - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> token = args[i];

    <span class="hljs-keyword">if</span> (collectArgs)
    {
      commandArgs.push(token);
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (suggestPoint &amp;&amp; (token == <span class="hljs-string">'--'</span> || token == <span class="hljs-string">'-'</span> || token[<span class="hljs-number">0</span>] != <span class="hljs-string">'-'</span>))
    {
      suggestStartsWith = token;
      <span class="hljs-keyword">break</span>; <span class="hljs-comment">// returns long option &amp; command list outside the loop</span>
    }

    <span class="hljs-keyword">if</span> (token == <span class="hljs-string">'--'</span>)
    {
      resultToken.args = commandArgs;
      commandArgs = [];
      noOptionsYet = <span class="hljs-literal">false</span>;
      collectArgs = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (token[<span class="hljs-number">0</span>] == <span class="hljs-string">'-'</span>)
    {
      noOptionsYet = <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">if</span> (commandArgs.length)
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>command.args_.apply(command, commandArgs);</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        resultToken.args = commandArgs;
        commandArgs = [];
      }

      <span class="hljs-keyword">if</span> (token[<span class="hljs-number">1</span>] == <span class="hljs-string">'-'</span>)
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>long option</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        option = command.long[token.substr(<span class="hljs-number">2</span>)];

        <span class="hljs-keyword">if</span> (!option)
        {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>option doesn't exist</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (suggestPoint)
            <span class="hljs-keyword">return</span> findVariants(command, token);
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Unknown option: '</span> + token);
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>process option</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        processOption(option, command);
      }
      <span class="hljs-keyword">else</span>
      {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>short flags sequence</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^-[a-zA-Z]+$/</span>.test(token))
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Wrong short option sequence: '</span> + token);

        <span class="hljs-keyword">if</span> (token.length == <span class="hljs-number">2</span>)
        {
          option = command.short[token[<span class="hljs-number">1</span>]];

          <span class="hljs-keyword">if</span> (!option)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Unknown short option name: -'</span> + token[<span class="hljs-number">1</span>]);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>single option</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          processOption(option, command);
        }
        <span class="hljs-keyword">else</span>
        {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>short options sequence</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">1</span>; j &lt; token.length; j++)
          {
            option = command.short[token[j]];

            <span class="hljs-keyword">if</span> (!option)
              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Unknown short option name: -'</span> + token[j]);

            <span class="hljs-keyword">if</span> (option.maxArgsCount)
              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Non-boolean option -'</span> + token[j] + <span class="hljs-string">' can\'t be used in short option sequence: '</span> + token);

            processOption(option, command);
          }
        }
      }
    }
    <span class="hljs-keyword">else</span>
    {
      <span class="hljs-keyword">if</span> (command.commands[token] &amp;&amp; (!command.params || commandArgs.length &gt;= command.params.minArgsCount))
      {
        <span class="hljs-keyword">if</span> (noOptionsYet)
        {
          resultToken.args = commandArgs;
          commandArgs = [];
        }

        <span class="hljs-keyword">if</span> (command.params &amp;&amp; resultToken.args.length &lt; command.params.minArgsCount)
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Missed required argument(s) for command `'</span> + command.name + <span class="hljs-string">'`'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>switch control to another command</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        command = command.commands[token];
        noOptionsYet = <span class="hljs-literal">true</span>;

        commandsPath.push(command.name);

        resultToken = {
          <span class="hljs-attr">command</span>: command,
          <span class="hljs-attr">args</span>: [],
          <span class="hljs-attr">literalArgs</span>: [],
          <span class="hljs-attr">options</span>: []
        };
        result.push(resultToken);
      }
      <span class="hljs-keyword">else</span>
      {
        <span class="hljs-keyword">if</span> (noOptionsYet &amp;&amp; command.params &amp;&amp; commandArgs.length &lt; command.params.maxArgsCount)
        {
          commandArgs.push(token);
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> (suggestPoint)
          <span class="hljs-keyword">return</span> findVariants(command, token);
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Unknown command: '</span> + token);
      }
    }
  }

  <span class="hljs-keyword">if</span> (suggest)
  {
    <span class="hljs-keyword">if</span> (collectArgs || noSuggestions)
      <span class="hljs-keyword">return</span> [];

    <span class="hljs-keyword">return</span> findVariants(command, suggestStartsWith);
  }
  <span class="hljs-keyword">else</span>
  {
    <span class="hljs-keyword">if</span> (!noOptionsYet)
      resultToken.literalArgs = commandArgs;
    <span class="hljs-keyword">else</span>
      resultToken.args = commandArgs;

    <span class="hljs-keyword">if</span> (command.params &amp;&amp; resultToken.args.length &lt; command.params.minArgsCount)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Missed required argument(s) for command `'</span> + command.name + <span class="hljs-string">'`'</span>);
  }

  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFunctionFactory</span>(<span class="hljs-params">name</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>)</span>{
    <span class="hljs-keyword">var</span> property = name + <span class="hljs-string">'_'</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[property] !== noop)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Method `'</span> + name + <span class="hljs-string">'` could be invoked only once'</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn != <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Value for `'</span> + name + <span class="hljs-string">'` method should be a function'</span>);

    <span class="hljs-keyword">this</span>[property] = fn;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<div class="dox">
<div class="summary">
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> Command = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, params</span>)</span>{
  <span class="hljs-keyword">this</span>.name = name;
  <span class="hljs-keyword">this</span>.params = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (params)
      <span class="hljs-keyword">this</span>.params = parseParams(params);
  } <span class="hljs-keyword">catch</span>(e) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Bad paramenter description in command definition: '</span> + <span class="hljs-keyword">this</span>.name + <span class="hljs-string">' '</span> + params);
  }

  <span class="hljs-keyword">this</span>.commands = {};

  <span class="hljs-keyword">this</span>.options = {};
  <span class="hljs-keyword">this</span>.short = {};
  <span class="hljs-keyword">this</span>.long = {};
  <span class="hljs-keyword">this</span>.values = {};
  <span class="hljs-keyword">this</span>.defaults_ = {};

  <span class="hljs-keyword">this</span>.suggestions = [];

  <span class="hljs-keyword">this</span>.option(<span class="hljs-string">'-h, --help'</span>, <span class="hljs-string">'Output usage information'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">this</span>.showHelp();
    process.exit(<span class="hljs-number">0</span>);
  }, <span class="hljs-literal">undefined</span>);
};

Command.prototype = {
  <span class="hljs-attr">params</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">commands</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">options</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">short</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">long</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">values</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">defaults_</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">suggestions</span>: <span class="hljs-literal">null</span>,

  <span class="hljs-attr">description_</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">version_</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">initContext_</span>: noop,
  <span class="hljs-attr">init_</span>: noop,
  <span class="hljs-attr">delegate_</span>: noop,
  <span class="hljs-attr">action_</span>: noop,
  <span class="hljs-attr">args_</span>: noop,
  <span class="hljs-attr">end_</span>: <span class="hljs-literal">null</span>,

  <span class="hljs-attr">option</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">usage, description, opt_1, opt_2</span>)</span>{
    addOptionToCommand(<span class="hljs-keyword">this</span>, createOption.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },
  <span class="hljs-attr">shortcut</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">usage, description, fn, opt_1, opt_2</span>)</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn != <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'fn should be a function'</span>);

    <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> option = addOptionToCommand(<span class="hljs-keyword">this</span>, createOption(usage, description, opt_1, opt_2));
    <span class="hljs-keyword">var</span> normalize = option.normalize;

    option.normalize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)</span>{
      <span class="hljs-keyword">var</span> values;

      value = normalize.call(command, value);
      values = fn(value);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> values)
        <span class="hljs-keyword">if</span> (hasOwnProperty.call(values, name))
          <span class="hljs-keyword">if</span> (hasOwnProperty.call(command.options, name))
            command.setOption(name, values[name]);
          <span class="hljs-keyword">else</span>
            command.values[name] = values[name];

      command.values[option.name] = value;

      <span class="hljs-keyword">return</span> value;
    };

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },
  <span class="hljs-attr">hasOption</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)</span>{
    <span class="hljs-keyword">return</span> hasOwnProperty.call(<span class="hljs-keyword">this</span>.options, name);
  },
  <span class="hljs-attr">hasOptions</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.options).length &gt; <span class="hljs-number">0</span>;
  },
  <span class="hljs-attr">setOption</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, value, isDefault</span>)</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOption(name))
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Option `'</span> + name + <span class="hljs-string">'` is not defined'</span>);

    <span class="hljs-keyword">var</span> option = <span class="hljs-keyword">this</span>.options[name];
    <span class="hljs-keyword">var</span> oldValue = <span class="hljs-keyword">this</span>.values[name];
    <span class="hljs-keyword">var</span> newValue = option.normalize.call(<span class="hljs-keyword">this</span>, value, oldValue);

    <span class="hljs-keyword">this</span>.values[name] = option.maxArgsCount ? newValue : value;

    <span class="hljs-keyword">if</span> (isDefault &amp;&amp; !hasOwnProperty.call(<span class="hljs-keyword">this</span>.defaults_, name))
      <span class="hljs-keyword">this</span>.defaults_[name] = <span class="hljs-keyword">this</span>.values[name];
  },
  <span class="hljs-attr">setOptions</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">values</span>)</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> values)
      <span class="hljs-keyword">if</span> (hasOwnProperty.call(values, name) &amp;&amp; <span class="hljs-keyword">this</span>.hasOption(name))
        <span class="hljs-keyword">this</span>.setOption(name, values[name]);
  },
  <span class="hljs-attr">reset</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">this</span>.values = {};

    assign(<span class="hljs-keyword">this</span>.values, <span class="hljs-keyword">this</span>.defaults_);
  },

  <span class="hljs-attr">command</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nameOrCommand, params</span>)</span>{
    <span class="hljs-keyword">var</span> name;
    <span class="hljs-keyword">var</span> command;

    <span class="hljs-keyword">if</span> (nameOrCommand <span class="hljs-keyword">instanceof</span> Command)
    {
      command = nameOrCommand;
      name = command.name;
    }
    <span class="hljs-keyword">else</span>
    {
      name = nameOrCommand;

      <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^[a-zA-Z][a-zA-Z0-9\-\_]*$/</span>.test(name))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Wrong command name: '</span> + name);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>search for existing one</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> subcommand = <span class="hljs-keyword">this</span>.commands[name];

    <span class="hljs-keyword">if</span> (!subcommand)
    {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>create new one if not exists</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      subcommand = command || <span class="hljs-keyword">new</span> Command(name, params);
      subcommand.end_ = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">this</span>.commands[name] = subcommand;
      <span class="hljs-keyword">this</span>.suggestions.push(name);
    }

    <span class="hljs-keyword">return</span> subcommand;
  },
  <span class="hljs-attr">end</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.end_;
  },
  <span class="hljs-attr">hasCommands</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.commands).length &gt; <span class="hljs-number">0</span>;
  },

  <span class="hljs-attr">version</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version, usage, description</span>)</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.version_)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Version for command could be set only once'</span>);

    <span class="hljs-keyword">this</span>.version_ = version;
    <span class="hljs-keyword">this</span>.option(
      usage || <span class="hljs-string">'-v, --version'</span>,
      description || <span class="hljs-string">'Output version'</span>,
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.version_);
        process.exit(<span class="hljs-number">0</span>);
      },
      <span class="hljs-literal">undefined</span>
    );

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },
  <span class="hljs-attr">description</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">description</span>)</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.description_)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Description for command could be set only once'</span>);

    <span class="hljs-keyword">this</span>.description_ = description;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  <span class="hljs-attr">init</span>: setFunctionFactory(<span class="hljs-string">'init'</span>),
  <span class="hljs-attr">initContext</span>: setFunctionFactory(<span class="hljs-string">'initContext'</span>),
  <span class="hljs-attr">args</span>: setFunctionFactory(<span class="hljs-string">'args'</span>),
  <span class="hljs-attr">delegate</span>: setFunctionFactory(<span class="hljs-string">'delegate'</span>),
  <span class="hljs-attr">action</span>: setFunctionFactory(<span class="hljs-string">'action'</span>),

  <span class="hljs-attr">extend</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>)</span>{
    fn.apply(<span class="hljs-literal">null</span>, [<span class="hljs-keyword">this</span>].concat(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  <span class="hljs-attr">parse</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, suggest</span>)</span>{
    <span class="hljs-keyword">if</span> (!args)
      args = process.argv.slice(<span class="hljs-number">2</span>);

    <span class="hljs-keyword">if</span> (!errorHandler)
      <span class="hljs-keyword">return</span> processArgs(<span class="hljs-keyword">this</span>, args, suggest);
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> processArgs(<span class="hljs-keyword">this</span>, args, suggest);
      } <span class="hljs-keyword">catch</span>(e) {
        errorHandler(e.message || e);
      }
  },
  <span class="hljs-attr">run</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, context</span>)</span>{
    <span class="hljs-keyword">var</span> commands = <span class="hljs-keyword">this</span>.parse(args);

    <span class="hljs-keyword">if</span> (!commands)
      <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> prevCommand;
    <span class="hljs-keyword">var</span> context = assign({}, context || <span class="hljs-keyword">this</span>.initContext_());
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; commands.length; i++)
    {
      <span class="hljs-keyword">var</span> item = commands[i];
      <span class="hljs-keyword">var</span> command = item.command;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>reset command values</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      command.reset();
      command.context = context;
      command.root = <span class="hljs-keyword">this</span>;

      <span class="hljs-keyword">if</span> (prevCommand)
        prevCommand.delegate_(command);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>apply beforeInit options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      item.options.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>)</span>{
        <span class="hljs-keyword">if</span> (entry.option.beforeInit)
          command.setOption(entry.option.camelName, entry.value);
      });

      command.init_(item.args.slice());   <span class="hljs-comment">// use slice to avoid args mutation in handler</span>

      <span class="hljs-keyword">if</span> (item.args.length)
        command.args_(item.args.slice()); <span class="hljs-comment">// use slice to avoid args mutation in handler</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>apply regular options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      item.options.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>)</span>{
        <span class="hljs-keyword">if</span> (!entry.option.beforeInit)
          command.setOption(entry.option.camelName, entry.value);
      });

      prevCommand = command;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>return last command action result</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (command)
      <span class="hljs-keyword">return</span> command.action_(item.args, item.literalArgs);
  },

  <span class="hljs-attr">normalize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">values</span>)</span>{
    <span class="hljs-keyword">var</span> result = {};

    <span class="hljs-keyword">if</span> (!values)
      values = {};

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.values)
      <span class="hljs-keyword">if</span> (hasOwnProperty.call(<span class="hljs-keyword">this</span>.values, name))
        result[name] = hasOwnProperty.call(values, name) &amp;&amp; hasOwnProperty.call(<span class="hljs-keyword">this</span>.options, name)
          ? <span class="hljs-keyword">this</span>.options[name].normalize.call(<span class="hljs-keyword">this</span>, values[name])
          : <span class="hljs-keyword">this</span>.values[name];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> values)
      <span class="hljs-keyword">if</span> (hasOwnProperty.call(values, name) &amp;&amp; !hasOwnProperty.call(result, name))
        result[name] = values[name];

    <span class="hljs-keyword">return</span> result;
  },

  <span class="hljs-attr">showHelp</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-built_in">console</span>.log(showCommandHelp(<span class="hljs-keyword">this</span>));
  }
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>help</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<div class="dox">
<div class="summary">
<p>Return program help documentation.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">String</span>
</div>
<div class="dox_tag_title">API</div>
<div class="dox_tag_detail">
<span class="dox_type">private</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showCommandHelp</span>(<span class="hljs-params">command</span>)</span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">breakByLines</span>(<span class="hljs-params">str, offset</span>)</span>{
    <span class="hljs-keyword">var</span> words = str.split(<span class="hljs-string">' '</span>);
    <span class="hljs-keyword">var</span> maxWidth = MAX_LINE_WIDTH - offset || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> lines = [];
    <span class="hljs-keyword">var</span> line = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">while</span> (words.length)
    {
      <span class="hljs-keyword">var</span> word = words.shift();
      <span class="hljs-keyword">if</span> (!line || (line.length + word.length + <span class="hljs-number">1</span>) &lt; maxWidth)
      {
        line += (line ? <span class="hljs-string">' '</span> : <span class="hljs-string">''</span>) + word;
      }
      <span class="hljs-keyword">else</span>
      {
        lines.push(line);
        words.unshift(word);
        line = <span class="hljs-string">''</span>;
      }
    }

    lines.push(line);

    <span class="hljs-keyword">return</span> lines.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line, idx</span>)</span>{
      <span class="hljs-keyword">return</span> (idx &amp;&amp; offset ? pad(offset, <span class="hljs-string">''</span>) : <span class="hljs-string">''</span>) + line;
    }).join(<span class="hljs-string">'\n'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">args</span>(<span class="hljs-params">command</span>)</span>{
    <span class="hljs-keyword">return</span> command.params.args.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>)</span>{
        <span class="hljs-keyword">return</span> arg.required
          ? <span class="hljs-string">'&lt;'</span> + arg.name + <span class="hljs-string">'&gt;'</span>
          : <span class="hljs-string">'['</span> + arg.name + <span class="hljs-string">']'</span>;
      }).join(<span class="hljs-string">' '</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commandsHelp</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span> (!command.hasCommands())
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

    <span class="hljs-keyword">var</span> maxNameLength = MIN_OFFSET - <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> lines = <span class="hljs-built_in">Object</span>.keys(command.commands).sort().map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)</span>{
      <span class="hljs-keyword">var</span> subcommand = command.commands[name];

      <span class="hljs-keyword">var</span> line = {
        <span class="hljs-attr">name</span>: chalk.green(name) + chalk.gray(
          (subcommand.params ? <span class="hljs-string">' '</span> + args(subcommand) : <span class="hljs-string">''</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>(subcommand.hasOptions() ? ' [options]' : '')</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        ),
        <span class="hljs-attr">description</span>: subcommand.description_ || <span class="hljs-string">''</span>
      };

      maxNameLength = <span class="hljs-built_in">Math</span>.max(maxNameLength, stringLength(line.name));

      <span class="hljs-keyword">return</span> line;
    });

    <span class="hljs-keyword">return</span> [
      <span class="hljs-string">''</span>,
      <span class="hljs-string">'Commands:'</span>,
      <span class="hljs-string">''</span>,
      lines.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'  '</span> + pad(maxNameLength, line.name) + <span class="hljs-string">'  '</span> + breakByLines(line.description, maxNameLength + <span class="hljs-number">4</span>);
      }).join(<span class="hljs-string">'\n'</span>),
      <span class="hljs-string">''</span>
    ].join(<span class="hljs-string">'\n'</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">optionsHelp</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span> (!command.hasOptions())
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

    <span class="hljs-keyword">var</span> hasShortOptions = <span class="hljs-built_in">Object</span>.keys(command.short).length &gt; <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> maxNameLength = MIN_OFFSET - <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> lines = <span class="hljs-built_in">Object</span>.keys(command.long).sort().map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)</span>{
      <span class="hljs-keyword">var</span> option = command.long[name];
      <span class="hljs-keyword">var</span> line = {
        <span class="hljs-attr">name</span>: option.usage
          .replace(<span class="hljs-regexp">/^(?:-., |)/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>)</span>{
            <span class="hljs-keyword">return</span> m || (hasShortOptions ? <span class="hljs-string">'    '</span> : <span class="hljs-string">''</span>);
          })
          .replace(<span class="hljs-regexp">/(^|\s)(-[^\s,]+)/ig</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m, p, flag</span>)</span>{
            <span class="hljs-keyword">return</span> p + chalk.yellow(flag);
          }),
        <span class="hljs-attr">description</span>: option.description
      };

      maxNameLength = <span class="hljs-built_in">Math</span>.max(maxNameLength, stringLength(line.name));

      <span class="hljs-keyword">return</span> line;
    });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>Prepend the help information</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> [
      <span class="hljs-string">''</span>,
      <span class="hljs-string">'Options:'</span>,
      <span class="hljs-string">''</span>,
      lines.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'  '</span> + pad(maxNameLength, line.name) + <span class="hljs-string">'  '</span> + breakByLines(line.description, maxNameLength + <span class="hljs-number">4</span>);
      }).join(<span class="hljs-string">'\n'</span>),
      <span class="hljs-string">''</span>
    ].join(<span class="hljs-string">'\n'</span>);
  }

  <span class="hljs-keyword">var</span> output = [];
  <span class="hljs-keyword">var</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>);

  chalk.enabled = <span class="hljs-built_in">module</span>.exports.color &amp;&amp; process.stdout.isTTY;

  <span class="hljs-keyword">if</span> (command.description_)
    output.push(command.description_ + <span class="hljs-string">'\n'</span>);

  output.push(
    <span class="hljs-string">'Usage:\n\n  '</span> +
      chalk.cyan(commandsPath ? commandsPath.join(<span class="hljs-string">' '</span>) : command.name) +
      (command.params ? <span class="hljs-string">' '</span> + chalk.magenta(args(command)) : <span class="hljs-string">''</span>) +
      (command.hasOptions() ? <span class="hljs-string">' ['</span> + chalk.yellow(<span class="hljs-string">'options'</span>) + <span class="hljs-string">']'</span> : <span class="hljs-string">''</span>) +
      (command.hasCommands() ? <span class="hljs-string">' ['</span> + chalk.green(<span class="hljs-string">'command'</span>) + <span class="hljs-string">']'</span> : <span class="hljs-string">''</span>),
    commandsHelp() +
    optionsHelp()
  );

  <span class="hljs-keyword">return</span> output.join(<span class="hljs-string">'\n'</span>);
};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>export</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">color</span>: <span class="hljs-literal">true</span>,

  <span class="hljs-attr">Error</span>: <span class="hljs-built_in">SyntaxError</span>,
  <span class="hljs-attr">Argument</span>: Argument,
  <span class="hljs-attr">Command</span>: Command,
  <span class="hljs-attr">Option</span>: Option,

  <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>)</span>{
    <span class="hljs-keyword">if</span> (errorHandler)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Error handler should be set only once'</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn != <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">'Error handler should be a function'</span>);

    errorHandler = fn;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  <span class="hljs-attr">create</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, params</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Command(name || <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>).basename(process.argv[<span class="hljs-number">1</span>]) || <span class="hljs-string">'cli'</span>, params);
  },

  <span class="hljs-attr">confirm</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message, fn</span>)</span>{
    process.stdout.write(message);
    process.stdin.setEncoding(<span class="hljs-string">'utf8'</span>);
    process.stdin.once(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>)</span>{
      process.stdin.pause();
      fn(<span class="hljs-regexp">/^y|yes|ok|true$/i</span>.test(val.trim()));
    });
    process.stdin.resume();
  }
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
